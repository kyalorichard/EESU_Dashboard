AWSTemplateFormatVersion: '2010-09-09'
Description: Full automated WordPress -> S3 -> Lambda -> Streamlit stack supporting staging & production

Parameters:
  Environment:
    Type: String
    AllowedValues:
      - staging
      - production
    Description: "Environment name"

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 KeyPair for SSH

  EC2InstanceType:
    Type: String
    Default: t3.micro

  UbuntuAmiId:
    Type: AWS::EC2::Image::Id

  VPCId:
    Type: AWS::EC2::VPC::Id

  SubnetIds:
    Type: CommaDelimitedList
    Description: Public subnets for EC2 and ALB

  GitHubRepo:
    Type: String
    Description: GitHub repository URL

  GitHubBranch:
    Type: String
    Description: Git branch (staging or main)

  NotificationEmail:
    Type: String

  SESNotificationEmail:
    Type: String

  LambdaScheduleExpression:
    Type: String
    Default: "cron(0 0 * * ? *)"

Resources:

  ###############################
  # S3 Bucket
  ###############################
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${Environment}-${AWS::StackName}-data"

  ###############################
  # IAM Role for Lambda
  ###############################
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - arn:aws:iam::aws:policy/AmazonSESFullAccess

  ###############################
  # Lambda Function
  ###############################
  WordPressSyncLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${Environment}-WordPressSyncLambda"
      Handler: lambda_function.lambda_handler
      Runtime: python3.11
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref S3Bucket
        S3Key: lambda/lambda.zip
      Timeout: 300
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          S3_BUCKET_NAME: !Ref S3Bucket
          S3_PREFIX: wp_incremental_csv
          SES_EMAIL: !Ref SESNotificationEmail
          DB_HOST: <DB_HOST>           # Fill in staging/prod DB in deploy script
          DB_USER: <DB_USER>
          DB_PASSWORD: <DB_PASSWORD>
          DB_NAME: <DB_NAME>

  ###############################
  # EventBridge Rule
  ###############################
  LambdaEventBridgeRule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: !Ref LambdaScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt WordPressSyncLambda.Arn
          Id: WordPressSyncLambdaTarget

  LambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WordPressSyncLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt LambdaEventBridgeRule.Arn

  ###############################
  # Security Group for EC2
  ###############################
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP/SSH
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8501
          ToPort: 8501
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  ###############################
  # IAM Role for EC2
  ###############################
  EC2InstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref EC2InstanceProfileRole]

  ###############################
  # EC2 Instance
  ###############################
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref EC2InstanceType
      KeyName: !Ref KeyName
      ImageId: !Ref UbuntuAmiId
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      SubnetId: !Select [0, !Ref SubnetIds]
      Tags:
        - Key: Name
          Value: !Sub "${Environment}-StreamlitEC2"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo apt-get update -y
          sudo apt-get install -y docker.io git amazon-cloudwatch-agent
          mkdir -p /home/ubuntu/app && cd /home/ubuntu/app
          git clone -b ${GitHubBranch} ${GitHubRepo} . || git pull
          cd streamlit
          docker build -t streamlit-dashboard .
          docker stop streamlit-dashboard || true
          docker rm streamlit-dashboard || true
          docker run -d -p 8501:8501 --name streamlit-dashboard \
            -e S3_BUCKET_NAME=${S3Bucket} \
            -e S3_PREFIX=wp_incremental_csv \
            streamlit-dashboard
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a start

Outputs:
  StreamlitURL:
    Description: "Streamlit dashboard endpoint"
    Value: !Sub "http://${EC2Instance.PublicDnsName}:8501"
