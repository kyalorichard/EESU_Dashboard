name: Deploy Streamlit Multi-Env

on:
  push:
    branches: [ main, staging ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v3

      # ENV detect
      - name: Set ENV
        run: |
          if [[ "${GITHUB_REF##*/}" == "staging" ]]; then
            echo "ENV=staging" >> $GITHUB_ENV
          else
            echo "ENV=production" >> $GITHUB_ENV
          fi

      # AWS auth
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Set host
      - name: Set host
        run: |
          if [[ "$ENV" == "staging" ]]; then
            echo "EC2_HOST=${{ secrets.EC2_HOST_STAGING }}" >> $GITHUB_ENV
            echo "${{ secrets.EC2_KEY_STAGING }}" > key.pem
          else
            echo "EC2_HOST=${{ secrets.EC2_HOST_PROD }}" >> $GITHUB_ENV
            echo "${{ secrets.EC2_KEY_PROD }}" > key.pem
          fi
          chmod 600 key.pem

      # Upload
      - name: Upload app
        run: |
          rsync -avz -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
          streamlit/ ubuntu@${EC2_HOST}:/home/ubuntu/app/

      # Backup image
      - name: Backup image
        run: |
          ssh -i key.pem ubuntu@${EC2_HOST} \
          "docker tag streamlit-dashboard streamlit-dashboard:backup || true"

      # Deploy container
      - name: Deploy container
        run: |
          ssh -i key.pem ubuntu@${EC2_HOST} << EOF
            cd ~/app
            docker build -t streamlit-dashboard .
            docker stop streamlit-dashboard || true
            docker rm streamlit-dashboard || true

            docker run -d -p 8501:8501 \
              -e S3_BUCKET_NAME=${ENV}-wordpress-dashboard-full-data \
              -e S3_PREFIX=wp_incremental_csv \
              --name streamlit-dashboard streamlit-dashboard
          EOF

      # Health check + rollback
      - name: Health check + rollback
        run: |
          sleep 25
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${EC2_HOST}:8501)

          if [ "$STATUS" != "200" ]; then
            echo "Deploy failed. Rolling back..."
            ssh -i key.pem ubuntu@${EC2_HOST} << EOF
              docker stop streamlit-dashboard || true
              docker rm streamlit-dashboard || true
              docker run -d -p 8501:8501 \
                --name streamlit-dashboard streamlit-dashboard:backup
            EOF
            exit 1
          fi

      # CloudFormation
      - name: CloudFormation Deploy
        run: |
          aws cloudformation deploy \
            --stack-name wordpress-dashboard-$ENV \
            --template-file cloudformation/full-stack-multi-env.yaml \
            --parameter-overrides \
              Environment=$ENV \
              NotificationEmail=${{ secrets.NOTIFICATION_EMAIL }} \
              SESNotificationEmail=${{ secrets.SES_EMAIL }} \
            --capabilities CAPABILITY_NAMED_IAM
