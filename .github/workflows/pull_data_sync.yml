name: WordPress Sync Every 2 Minutes

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymysql boto3 pandas python-dotenv

      - name: Create .env from GitHub Secrets
        run: |
          echo "" > .env
          for key in REGION LAMBDA_ROLE LAMBDA_NAME_STAGING LAMBDA_NAME_PROD \
                     DB_HOST DB_USER DB_PASS DB_NAME S3_BUCKET_STAGING S3_BUCKET_PROD \
                     CSV_KEY CHECKPOINT_KEY SES_FROM SES_TO NOTIFICATION_EMAIL \
                     EC2_USER EC2_HOST_STAGING EC2_HOST_PROD EC2_KEY \
                     DOCKER_IMAGE_TAG_STAGING DOCKER_IMAGE_TAG_PROD STREAMLIT_PORT \
                     COUNTRY_META_FILE GEOJSON_FILE AUTORELOAD_INTERVAL CHECKPOINT_TTL \
                     OPENAI_API_KEY NOTIFY_EMAIL SMTP_USER SMTP_PASS SMTP_HOST SMTP_PORT TEST_ROWS
          do
            echo "$key=${{ secrets[$key] }}" >> .env
          done

      - name: Run WordPress Sync
        id: wp_sync
        run: |
          set -o pipefail
          mkdir -p logs
          LOG_FILE=logs/wp_sync.txt
          SYNC_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "Starting WordPress sync at $SYNC_TIME" | tee -a $LOG_FILE
          OUTPUT=$(python pull_data.py 2>&1 | tee -a $LOG_FILE)

          echo "SYNC_OUTPUT=$OUTPUT" >> $GITHUB_ENV
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
          echo "SYNC_TIME=$SYNC_TIME" >> $GITHUB_ENV

      - name: Prepare HTML email content with conditional coloring
        id: prepare_email
        shell: bash
        run: |
          python - <<'EOF'
import os, json
print("âœ… heredoc working")
EOF
