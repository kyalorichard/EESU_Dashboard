name: WordPress Sync Every 2 Minutes

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymysql boto3 pandas python-dotenv

      - name: Create .env from GitHub Secrets
        run: |
          echo "" > .env
          for key in REGION LAMBDA_ROLE LAMBDA_NAME_STAGING LAMBDA_NAME_PROD \
                     DB_HOST DB_USER DB_PASS DB_NAME S3_BUCKET_STAGING S3_BUCKET_PROD \
                     CSV_KEY CHECKPOINT_KEY SES_FROM SES_TO NOTIFICATION_EMAIL \
                     EC2_USER EC2_HOST_STAGING EC2_HOST_PROD EC2_KEY \
                     DOCKER_IMAGE_TAG_STAGING DOCKER_IMAGE_TAG_PROD STREAMLIT_PORT \
                     COUNTRY_META_FILE GEOJSON_FILE AUTORELOAD_INTERVAL CHECKPOINT_TTL \
                     OPENAI_API_KEY NOTIFY_EMAIL SMTP_USER SMTP_PASS SMTP_HOST SMTP_PORT TEST_ROWS
          do
            echo "$key=${{ secrets[$key] }}" >> .env
          done

      - name: Run WordPress Sync
        id: wp_sync
        run: |
          set -o pipefail
          mkdir -p logs
          LOG_FILE=logs/wp_sync.txt
          SYNC_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "Starting WordPress sync at $SYNC_TIME" | tee -a $LOG_FILE
          OUTPUT=$(python pull_data.py 2>&1 | tee -a $LOG_FILE)
          echo "$OUTPUT"
          echo "SYNC_OUTPUT=$OUTPUT" >> $GITHUB_ENV
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
          echo "SYNC_TIME=$SYNC_TIME" >> $GITHUB_ENV

      - name: Prepare HTML email content with conditional coloring
        id: prepare_email
        run: |
          python - <<'EOF'
import os, json

raw = os.environ.get("SYNC_OUTPUT", "{}")
if raw.startswith("'") and raw.endswith("'"):
    raw = raw[1:-1].replace("'\"'\"'", "'")
try:
    data = json.loads(raw)
except json.JSONDecodeError:
    data = {"status": "failed", "error": "Invalid JSON output", "execution_time": 0}

status = data.get("status")
new_posts = data.get("new_rows", 0)
total_posts = data.get("total_rows", 0)
batches = data.get("batches", 0)
exec_time = data.get("execution_time", 0)
sync_time = os.environ.get("SYNC_TIME", "Unknown time")
repo = os.environ.get("GITHUB_REPOSITORY")
run_id = os.environ.get("GITHUB_RUN_ID")
artifact_page = f"https://github.com/{repo}/runs/{run_id}/artifacts"

# Determine cell colors
def color_icon(value, success=True, custom_color=None):
    color = custom_color if custom_color else ('green' if success else 'red')
    return f"<td style='color:{color}; text-align:center;'>{value}</td>"

# Conditional color for new posts
new_posts_color = 'green' if new_posts > 0 else 'gray'

# Build HTML table with conditional coloring
table = f"""
<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:450px;">
<tr style="background-color:#f2f2f2;"><th>Metric</th><th>Value</th><th>Status</th></tr>
<tr><td>New Posts</td><td>{new_posts}</td>{color_icon('✅', True, new_posts_color)}</tr>
<tr><td>Total Posts</td><td>{total_posts}</td>{color_icon('✅', total_posts>=0)}</tr>
<tr><td>Batches</td><td>{batches}</td>{color_icon('✅', batches>=0)}</tr>
<tr><td>Execution Time</td><td>{exec_time:.2f} sec</td>{color_icon('✅', exec_time>=0)}</tr>
<tr><td>Last Sync</td><td>{sync_time}</td>{color_icon('✅', status!='failed')}</tr>
</table>
"""

# Construct email body
if status == "success":
    body = f"<h3>✅ WordPress Sync Successful!</h3>{table}<p>Download the log <a href='{artifact_page}'>here</a>.</p>"
    skip_email = False
    subject = f"✅ WordPress Sync: {new_posts} New Posts ({sync_time})"
elif status == "no_new_posts":
    body = f"<h3>✅ WordPress Sync Completed: No New Posts</h3>{table}<p>Download the log <a href='{artifact_page}'>here</a>.</p>"
    skip_email = True
    subject = f"✅ WordPress Sync: No New Posts ({sync_time})"
else:
    body = f"<h3>❌ WordPress Sync FAILED!</h3>{table}<p>Download the log <a href='{artifact_page}'>here</a>.</p>"
    skip_email = False
    subject = f"❌ WordPress Sync FAILED ({sync_time})"

# Write environment variables
with open(os.environ['GITHUB_ENV'], 'a') as f:
    f.write("EMAIL_BODY<<EOF\n")
    f.write(body + "\n")
    f.write("EOF\n")
    f.write(f"EMAIL_SUBJECT={subject}\n")
    f.write(f"SKIP_EMAIL={str(skip_email)}\n")
EOF

      - name: Send HTML Email Notification
        if: ${{ env.SKIP_EMAIL != 'True' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: ${{ env.EMAIL_SUBJECT }}
          body: ${{ env.EMAIL_BODY }}
          body_type: html
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USER }}
          secure: true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wp-sync-log
          path: ${{ env.LOG_FILE }}
          if-no-files-found: warn
